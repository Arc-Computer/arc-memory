> Status Proposed
>
> **Date** 23 Apr 2025
>
> **Decision makers** Jarrod Barnes (Founder), Core Eng Team
>
> **Context** Arc’s first public beta must (a) deliver immediate value inside the diff-review loop, (b) expose a temporal knowledge graph to agents, and (c) remain 100 % local-first.
>

---

## 1 · Product Vision (v1)

> “Every changed line knows its past.”
>
- In 12 months AI agents will write 10× more code.
- 38 % of reviews already need **temporal reasoning** over commits / PRs / issues / ADRs.
- Arc embeds a **bi-temporal knowledge graph (TKG)** inside the IDE to surface verifiable decision trails and power any coding agent.

**North-star outcome**: Reviewers resolve complex PRs 30 % faster; agents avoid regressions by consulting Arc tools.

---

## 2 · Core Persona

| Role | Pain today | Arc promise |
| --- | --- | --- |
| **Staff+ platform engineer** (8 – 12 yrs exp, owns CI & coding-standards) | Spends ~20 % of PR time chasing history, ADRs, security fixes; fears AI patches will re-open old bugs. | Hover a line once and see commit → PR → issue → ADR trace; let an agent auto-check the lineage. |

---

## 3 · Desired Beta Experience

```
pip install arc-memory     #  5 s
arc auth gh                # 30 s (GitHub device flow)
arc-build                  # 20–60 s (build graph.db.zst)
code .                     # open repo
▶ Hover in diff editor     #  <200 ms pop-up with decision trail
▶ Copilot agent            #  calls /traceHistory to plan fix

```

---

## 4 · System Breakdown (v0.9)

```
github.com/arc-memory/
├─ arc-memory-common   · graph library & CLI (Python)
├─ arc-memory-mcp      · edge server & tools (Go/TS + SQLite)
└─ vscode-arc-hover    · thin VS Code extension (TypeScript)

```

### 4.1 `arc-memory-common` (Python / MIT)

| Module | Responsibility |
| --- | --- |
| `schema.py` | Pydantic models: `CommitNode`, `PRNode`, `IssueNode`, `ADRNode` |
| `ingest.py` | `git log` parsing, GitHub App API calls, ADR glob |
| `sql_helpers.py` | Create SQLite tables, FTS5 index, 2-hop BFS queries |
| **CLI** | `arc-build` (graph build) · `arc auth gh` (device-flow login) |

### 4.2 `arc-memory-mcp` (Edge server)

| Binary | Routes | Notes |
| --- | --- | --- |
| `arc serve` | `/searchEntity`, `/traceHistory`, `/openFile`, `/runTests` (optional) | Reads `~/.arc/graph.db`; serves `tools/manifest.json` for Agent Mode; signs JWT ⇒ installation token if GitHub App creds present. |

### 4.3 `vscode-arc-hover` (Extension)

- `HoverProvider` for `scheme:'git'` → calls `/traceHistory`.
- Gutter icon decoration.
- Tree-view timeline (lazy).
- Command `Arc: Start Memory Server` (spawns `arc serve`).

---

## 5 · Data Model & Sources

| Node types | Source | Key props |
| --- | --- | --- |
| **Commit** | `git log --pretty` | hash, author, date, message |
| **PR** | GitHub REST `/pulls` | id, title, body, merged_sha |
| **Issue** | REST `/issues` + `/timeline` | id, title, body, labels |
| **ADR** | `**/adr/**/*.md` | slug, title, body |

Edges: `MODIFIES`, `MERGES`, `MENTIONS`, `DECIDES`.

DB = SQLite (`nodes`, `edges`, full-text FTS5 on `nodes.body`).

Average repo: 5 MB compressed.

---

## 6 · Functional Requirements

### R-F1 `/traceHistory`

*Input:* repo, file, line

*Output:* ordered `[commit, PR?, issue?, ADR?]` (max 3)

### R-F2 `/searchEntity`

*Input:* keyword(s)

*Output:* top-5 node IDs (FTS5 rank)

### R-F3 `/openFile`

*Input:* id

*Output:* raw diff (commit) or browser link (PR/issue)

### Extension UX

- Hover latency p95 ≤ 200 ms.
- Timeline shows last 15 events with “Load more”.
- Link-outs: click PR opens GitHub URL.

---

## 7 · Non-Functional / Quality Attributes

| Attribute | Target |
| --- | --- |
| **Local-first** | No external calls after build. |
| **Privacy** | Tokens stored in OS keychain; graph stays on disk. |
| **Performance** | Hover ≤ 200 ms · MCP CPU < 30 %. |
| **Portability** | macOS, Linux, Windows (WSL) binaries. |

---

## 8 · Milestones (3-week sprint)

| Week | Deliverables |
| --- | --- |
| **1** | GitHub App registered; `arc auth gh` device flow; base ingestion → `graph.db`. |
| **2** | `arc serve` with `/traceHistory` + manifest; extension HoverProvider + gutter icons. |
| **3** | Timeline tree view; `/runTests` container harness; Loom demo; internal dog-food. |

KPIs checked end of Week 3.

---

## 9 · Incremental Build Strategy

### 9.1 Design Principles
* Minimize GitHub API calls to avoid rate limits
* Reduce build time for frequent updates
* Support CI/CD integration for team-wide graph updates
* Maintain extensibility for future data sources

### 9.2 Implementation
* Store metadata in `build.json` including:
  * `last_commit_hash`: Most recent commit processed
  * `last_build_timestamp`: ISO-8601 timestamp of last build
  * `processed_ids`: Map of PR/issue IDs and their last update time
  * `schema_version`: For compatibility checks
* Incremental git processing:
  * Use `git log <last_commit_hash>..HEAD` to get only new commits
* Incremental GitHub API calls:
  * Use `since=<timestamp>` parameter for PRs and issues
* Incremental ADR processing:
  * Track file modification times and only reprocess changed files
* Database updates:
  * Use SQLite transactions for atomic updates
  * Add new nodes and edges without rebuilding entire graph

### 9.3 CI Integration
* GitHub Actions workflow triggered on:
  * Commits to main/master
  * PR creation/updates
  * Issue creation/updates
* Workflow publishes updated `graph.db.zst` as artifact
* Developers run `arc build --pull` to fetch latest graph

## 10 · Open Questions

1. ADR front-matter spec: *conventional-commits* vs custom?
2. Rate-limit handling for very large OSS repos (10 k PRs)?
3. Docker image size for `/runTests`; should we host a base image?
4. Best storage strategy for CI-built graphs: artifacts vs. commits?

---

## 11 · Decision

*Adopt the three-repo architecture with GitHub App OAuth, SQLite + NetworkX graph, and thin VS Code UI. Prioritise hover latency and provenance accuracy; vector search deferred.*

**Accepted** ✔️ – 24 Apr 2025

— Jarrod Barnes

---

## ✅ Checklist - verified & augmented

| Area | Already captured | **New fine-points to add (✔︎ = added)** |
| --- | --- | --- |
| **Python 3.12 baseline** | ✔︎ | — |
| **Dependencies ≤ 15 MB** | networkx, apsw, requests, pydantic v2, typer, jwt, yaml, markdown-it, zstandard, tqdm | ✔︎ `keyring` for secure token storage |
| **Project layout** | `/schema.py /ingest/ /sql.py /cli/` | ✔︎ `logging_conf.py` with `DEBUG / INFO` switch |
| **Type safety** | Pydantic v2 `BaseModel` + strict mypy | — |
| **Graph schema** | Node & edge enums | — |
| **SQLite + FTS5** | nodes, edges, FTS5 index | ✔︎ `PRAGMA journal_mode=WAL` for concurrent reads |
| **Compression** | zstd level 3 | — |
| **CLI via Typer** | commands `auth`, `build`, `doctor`, `version` | ✔︎ Added `build --incremental` and `build --pull` for CI integration |
| **GitHub App auth** | device-flow helper, JWT → installation token | — |
| **Token discovery order** | CLI flag → env → keyring → fail offline | ✔︎ Auto-detect Codespaces `$GITHUB_TOKEN` |
| **Plugin entry-point** | `arc_ingest` namespace | — |
| **Unit tests 80 % cov** | pytest + `responses` for API mocks | — |
| **Sample repo fixture** | 200-commit toy repo | — |
| **CI matrix** | ubuntu & macOS; build wheel, publish TestPyPI | ✔︎ `pre-commit` hooks (black, isort, mypy) on PRs |
| **Docs** | MkDocs site | ✔︎ Add ADR-001 link & quick-start snippet |
| **Package metadata** | name `arc-memory`, version `0.1.0b{date}` | ✔︎ `license="MIT"` & classifiers for PyPI |
| **Logging & error taxonomy** | — | ✔︎ Custom `ArcError` base; raise `GitHubAuthError`, `GraphBuildError` subclasses |
| **Build manifest** | — | ✔︎ Added `last_commit_hash`, `last_build_timestamp`, and `processed_ids` to `build.json` for incremental builds |
| **Future hooks** | TODOs for FAISS & GitLab | ✔︎ Added plugin architecture for extensible ingestors (GitLab, Jira, etc.) |
| **Security** | keyring storage, no token in graph file | ✔︎ Strip e-mails from nodes before persist |

---

## Build-order confirmation

1. **`arc-memory`** (library + CLI) — start now.
2. **`arc-serve`** (MCP) — imports `arc-memory` once graph build is stable.
3. **`vscode-arc`** — after MCP route names are frozen.